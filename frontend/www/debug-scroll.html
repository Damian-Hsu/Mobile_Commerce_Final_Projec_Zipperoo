<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天滾動調試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .button-group {
            margin: 10px 0;
        }
        
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .info-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>聊天滾動調試工具</h1>
    
    <div class="debug-panel">
        <h3>容器檢查</h3>
        <div class="button-group">
            <button onclick="checkContainers()">檢查滾動容器</button>
            <button onclick="checkScrollProperties()">檢查滾動屬性</button>
            <button onclick="testDirectScroll()">測試直接滾動</button>
            <button onclick="addTestMessage()">添加測試訊息</button>
        </div>
        <div id="containerInfo" class="info-box">點擊按鈕開始檢查...</div>
    </div>
    
    <div class="debug-panel">
        <h3>聊天頁面測試</h3>
        <div class="button-group">
            <button onclick="openChatPage()">打開聊天頁面</button>
            <button onclick="testChatScroll()">測試聊天滾動</button>
            <button onclick="forceChatScroll()">強制聊天滾動</button>
        </div>
        <div id="chatInfo" class="info-box">聊天頁面測試結果將顯示在這裡...</div>
    </div>
    
    <div class="debug-panel">
        <h3>實時監控</h3>
        <div class="button-group">
            <button onclick="startMonitoring()">開始監控</button>
            <button onclick="stopMonitoring()">停止監控</button>
        </div>
        <div id="monitorInfo" class="info-box">監控信息將顯示在這裡...</div>
    </div>

    <script>
        let monitorInterval = null;
        
        function checkContainers() {
            const info = document.getElementById('containerInfo');
            
            try {
                // 檢查是否在聊天頁面
                if (!window.chatPage) {
                    info.textContent = '錯誤: 聊天頁面未載入。請先打開聊天頁面。';
                    info.className = 'info-box error';
                    return;
                }
                
                const messagesContainer = document.getElementById('messages-container');
                const messagesList = document.getElementById('messages-list');
                
                let result = '=== 容器檢查結果 ===\n\n';
                
                result += `messages-container 存在: ${!!messagesContainer}\n`;
                if (messagesContainer) {
                    result += `  - ID: ${messagesContainer.id}\n`;
                    result += `  - 類名: ${messagesContainer.className}\n`;
                    result += `  - 滾動高度: ${messagesContainer.scrollHeight}px\n`;
                    result += `  - 客戶端高度: ${messagesContainer.clientHeight}px\n`;
                    result += `  - 滾動位置: ${messagesContainer.scrollTop}px\n`;
                    result += `  - 溢出樣式: ${getComputedStyle(messagesContainer).overflow}\n`;
                    result += `  - 溢出Y樣式: ${getComputedStyle(messagesContainer).overflowY}\n`;
                }
                
                result += `\nmessages-list 存在: ${!!messagesList}\n`;
                if (messagesList) {
                    result += `  - ID: ${messagesList.id}\n`;
                    result += `  - 類名: ${messagesList.className}\n`;
                    result += `  - 滾動高度: ${messagesList.scrollHeight}px\n`;
                    result += `  - 客戶端高度: ${messagesList.clientHeight}px\n`;
                    result += `  - 滾動位置: ${messagesList.scrollTop}px\n`;
                    result += `  - 溢出樣式: ${getComputedStyle(messagesList).overflow}\n`;
                    result += `  - 溢出Y樣式: ${getComputedStyle(messagesList).overflowY}\n`;
                }
                
                result += `\n聊天頁面實例:\n`;
                result += `  - messagesList: ${!!window.chatPage.messagesList}\n`;
                result += `  - messagesContainer: ${!!window.chatPage.messagesContainer}\n`;
                
                info.textContent = result;
                info.className = 'info-box success';
                
            } catch (error) {
                info.textContent = `錯誤: ${error.message}`;
                info.className = 'info-box error';
            }
        }
        
        function checkScrollProperties() {
            const info = document.getElementById('containerInfo');
            
            try {
                const messagesList = document.getElementById('messages-list');
                if (!messagesList) {
                    info.textContent = '錯誤: messages-list 元素未找到';
                    info.className = 'info-box error';
                    return;
                }
                
                const style = getComputedStyle(messagesList);
                let result = '=== messages-list 滾動屬性 ===\n\n';
                
                result += `尺寸屬性:\n`;
                result += `  - scrollHeight: ${messagesList.scrollHeight}px\n`;
                result += `  - clientHeight: ${messagesList.clientHeight}px\n`;
                result += `  - offsetHeight: ${messagesList.offsetHeight}px\n`;
                result += `  - scrollTop: ${messagesList.scrollTop}px\n`;
                result += `  - 最大滾動: ${messagesList.scrollHeight - messagesList.clientHeight}px\n`;
                
                result += `\nCSS 屬性:\n`;
                result += `  - overflow: ${style.overflow}\n`;
                result += `  - overflow-y: ${style.overflowY}\n`;
                result += `  - height: ${style.height}\n`;
                result += `  - max-height: ${style.maxHeight}\n`;
                result += `  - flex: ${style.flex}\n`;
                result += `  - display: ${style.display}\n`;
                result += `  - position: ${style.position}\n`;
                
                result += `\n子元素數量: ${messagesList.children.length}\n`;
                
                info.textContent = result;
                info.className = 'info-box success';
                
            } catch (error) {
                info.textContent = `錯誤: ${error.message}`;
                info.className = 'info-box error';
            }
        }
        
        function testDirectScroll() {
            const info = document.getElementById('containerInfo');
            
            try {
                const messagesList = document.getElementById('messages-list');
                if (!messagesList) {
                    info.textContent = '錯誤: messages-list 元素未找到';
                    info.className = 'info-box error';
                    return;
                }
                
                let result = '=== 直接滾動測試 ===\n\n';
                
                result += `滾動前:\n`;
                result += `  - scrollTop: ${messagesList.scrollTop}\n`;
                result += `  - scrollHeight: ${messagesList.scrollHeight}\n`;
                result += `  - clientHeight: ${messagesList.clientHeight}\n`;
                
                // 執行滾動
                messagesList.scrollTop = messagesList.scrollHeight;
                
                result += `\n滾動後:\n`;
                result += `  - scrollTop: ${messagesList.scrollTop}\n`;
                result += `  - scrollHeight: ${messagesList.scrollHeight}\n`;
                result += `  - clientHeight: ${messagesList.clientHeight}\n`;
                
                const isAtBottom = Math.abs(messagesList.scrollHeight - (messagesList.scrollTop + messagesList.clientHeight)) < 5;
                result += `\n滾動成功: ${isAtBottom}`;
                
                info.textContent = result;
                info.className = isAtBottom ? 'info-box success' : 'info-box error';
                
            } catch (error) {
                info.textContent = `錯誤: ${error.message}`;
                info.className = 'info-box error';
            }
        }
        
        function addTestMessage() {
            try {
                const messagesList = document.getElementById('messages-list');
                if (!messagesList) return;
                
                const message = document.createElement('div');
                message.className = 'message-item';
                message.innerHTML = `
                    <div class="message-avatar">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            測試訊息 ${Date.now()}
                        </div>
                        <div class="message-time">剛剛</div>
                    </div>
                `;
                
                messagesList.appendChild(message);
                
                // 自動滾動到底部
                setTimeout(() => {
                    testDirectScroll();
                }, 100);
                
            } catch (error) {
                console.error('添加測試訊息失敗:', error);
            }
        }
        
        function openChatPage() {
            window.open('/chat', '_blank');
        }
        
        function testChatScroll() {
            const info = document.getElementById('chatInfo');
            
            try {
                if (window.chatPage && window.chatPage.forceScrollToBottomTest) {
                    const result = window.chatPage.forceScrollToBottomTest();
                    info.textContent = `聊天滾動測試結果: ${result ? '成功' : '失敗'}`;
                    info.className = result ? 'info-box success' : 'info-box error';
                } else {
                    info.textContent = '錯誤: 聊天頁面未載入或測試方法不可用';
                    info.className = 'info-box error';
                }
            } catch (error) {
                info.textContent = `錯誤: ${error.message}`;
                info.className = 'info-box error';
            }
        }
        
        function forceChatScroll() {
            const info = document.getElementById('chatInfo');
            
            try {
                if (window.chatPage) {
                    window.chatPage.scrollToBottom(true);
                    info.textContent = '強制滾動命令已執行，請檢查控制台日志';
                    info.className = 'info-box success';
                } else {
                    info.textContent = '錯誤: 聊天頁面未載入';
                    info.className = 'info-box error';
                }
            } catch (error) {
                info.textContent = `錯誤: ${error.message}`;
                info.className = 'info-box error';
            }
        }
        
        function startMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }
            
            const info = document.getElementById('monitorInfo');
            
            monitorInterval = setInterval(() => {
                try {
                    const messagesList = document.getElementById('messages-list');
                    if (!messagesList) {
                        info.textContent = '監控中... (messages-list 未找到)';
                        return;
                    }
                    
                    const now = new Date().toLocaleTimeString();
                    const scrollInfo = {
                        time: now,
                        scrollTop: messagesList.scrollTop,
                        scrollHeight: messagesList.scrollHeight,
                        clientHeight: messagesList.clientHeight,
                        isAtBottom: Math.abs(messagesList.scrollHeight - (messagesList.scrollTop + messagesList.clientHeight)) < 5
                    };
                    
                    info.textContent = `監控中... (${now})\n` +
                        `scrollTop: ${scrollInfo.scrollTop}\n` +
                        `scrollHeight: ${scrollInfo.scrollHeight}\n` +
                        `clientHeight: ${scrollInfo.clientHeight}\n` +
                        `isAtBottom: ${scrollInfo.isAtBottom}`;
                    
                } catch (error) {
                    info.textContent = `監控錯誤: ${error.message}`;
                }
            }, 1000);
            
            info.textContent = '開始監控...';
            info.className = 'info-box success';
        }
        
        function stopMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
            
            const info = document.getElementById('monitorInfo');
            info.textContent = '監控已停止';
            info.className = 'info-box';
        }
    </script>
</body>
</html> 